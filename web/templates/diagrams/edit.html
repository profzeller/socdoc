{% extends "_base.html" %}
{% block title %}
  {% if diagram %}Edit Diagram{% else %}New Diagram{% endif %}
{% endblock %}

{% block content %}
<h1>
  {% if diagram %}Edit Diagram{% else %}New Diagram{% endif %}
</h1>

{# Helpful Fossflow button if configured #}
{% if fossflow_url %}
  <p style="margin-bottom:1rem;">
    <a href="{{ fossflow_url }}" target="_blank" rel="noopener" class="btn">
      ðŸ§© Open Fossflow to design your diagram
    </a>
    <span style="font-size:.9rem;color:#64748b;display:block;margin-top:.25rem;">
      Build the diagram in Fossflow, then either upload an exported PNG/JPG below
      or paste the diagramâ€™s share URL into the external link field.
    </span>
  </p>
{% endif %}

<form method="post" enctype="multipart/form-data" id="diagram-form">
  {% csrf_token %}
  {{ form.non_field_errors }}

  <p>
    {{ form.title.label_tag }}<br>
    {{ form.title }}
  </p>

  <p>
    {{ form.image.label_tag }}<br>
    {{ form.image }}
    <small style="color:#64748b;display:block;margin-top:0.25rem;">
      Upload a PNG/JPG export of your diagram.
    </small>
  </p>

  {% if diagram and diagram.image %}
    <p>
      <strong>Current image:</strong><br>
      <img src="{{ diagram.image.url }}" alt="{{ diagram.title }}"
           style="max-width: 100%; border-radius: 0.5rem; border:1px solid #e2e8f0; margin-top:0.25rem;">
    </p>
  {% endif %}

  <p>
    {{ form.external_url.label_tag }}<br>
    {{ form.external_url }}
    <small style="color:#64748b;display:block;margin-top:0.25rem;">
      Optional: direct link to Lucidchart / draw.io / Fossflow / Excalidraw, etc.
    </small>
  </p>

  {# Markdown notes with toolbar + optional preview #}
  <div class="md-editor" data-doc-key="{{ diagram.slug|default_if_none:'diagram-notes' }}">
    <div class="md-editor-main">
      <div class="md-editor-header">
        <label for="{{ form.notes.id_for_label }}"><strong>Notes (Markdown)</strong></label>
        <button type="button" id="toggle-preview" class="md-preview-toggle">
          Show Preview
        </button>
      </div>

      <div class="md-toolbar">
        <button type="button" data-md="h1">H1</button>
        <button type="button" data-md="h2">H2</button>
        <button type="button" data-md="bold"><strong>B</strong></button>
        <button type="button" data-md="italic"><em>I</em></button>
        <button type="button" data-md="ul">â€¢ List</button>
        <button type="button" data-md="code">{"</>"}</button>
      </div>

      {{ form.notes }}

      <small style="color:#64748b; display:block; margin-top:0.25rem;">
        Use Markdown to describe flows, assumptions, components, etc.
        <a href="https://www.markdownguide.org/basic-syntax/" target="_blank">Markdown basics</a> Â·
        <a href="https://github.github.com/gfm/" target="_blank">GitHub-flavored Markdown</a>
      </small>

      <p id="autosave-status" class="autosave-status"></p>
    </div>

    <div class="md-preview">
      <div class="md-preview-inner" id="md-preview"></div>
    </div>
  </div>

  <button type="submit" class="btn">
    {% if diagram %}Save Changes{% else %}Create Diagram{% endif %}
  </button>
</form>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  (function () {
    const textarea = document.getElementById('{{ form.notes.id_for_label }}') || document.getElementById('id_notes');
    if (!textarea) return;

    const preview = document.getElementById('md-preview');
    const editor = document.querySelector('.md-editor');
    const status = document.getElementById('autosave-status');
    const previewToggle = document.getElementById('toggle-preview');
    const previewColumn = preview ? preview.parentElement : null;

    const storageKeyBase = 'socdocs-diagram-notes-';
    const docKeyAttr = editor ? editor.getAttribute('data-doc-key') : '';
    const storageKey = storageKeyBase + (docKeyAttr || window.location.pathname);

    let previewVisible = false;
    if (previewColumn) {
      previewColumn.style.display = 'none';
    }
    if (previewToggle) {
      previewToggle.addEventListener('click', function () {
        previewVisible = !previewVisible;
        if (previewColumn) {
          previewColumn.style.display = previewVisible ? 'block' : 'none';
        }
        previewToggle.textContent = previewVisible ? 'Hide Preview' : 'Show Preview';
      });
    }

    const savedDraft = localStorage.getItem(storageKey);
    if (savedDraft && !textarea.value) {
      textarea.value = savedDraft;
    }

    function renderPreview() {
      if (!preview) return;
      if (typeof marked !== 'undefined') {
        preview.innerHTML = marked.parse(textarea.value || '');
      } else {
        preview.textContent = textarea.value || '';
      }
    }

    let saveTimeout = null;
    function scheduleAutosave() {
      if (saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(function () {
        localStorage.setItem(storageKey, textarea.value || '');
        if (status) {
          const now = new Date();
          status.textContent = 'Draft saved at ' + now.toLocaleTimeString();
        }
      }, 600);
    }

    textarea.addEventListener('input', function () {
      renderPreview();
      scheduleAutosave();
    });

    function wrapSelection(before, after) {
      const start = textarea.selectionStart || 0;
      const end = textarea.selectionEnd || 0;
      const value = textarea.value;
      const selected = value.slice(start, end);
      const newText = before + selected + (after != null ? after : '');
      textarea.setRangeText(newText, start, end, 'end');
      textarea.dispatchEvent(new Event('input'));
      textarea.focus();
    }

    function insertLinePrefix(prefix) {
      const start = textarea.selectionStart || 0;
      const end = textarea.selectionEnd || 0;
      const value = textarea.value;
      const before = value.slice(0, start);
      const selected = value.slice(start, end) || 'List item';
      const after = value.slice(end);

      const lines = selected.split('\n').map(l => {
        return l.trim() ? prefix + ' ' + l.trim() : prefix + ' ';
      });
      const newBlock = lines.join('\n');

      textarea.value = before + newBlock + after;
      const newCursor = before.length + newBlock.length;
      textarea.setSelectionRange(newCursor, newCursor);
      textarea.dispatchEvent(new Event('input'));
      textarea.focus();
    }

    document.querySelectorAll('.md-toolbar button[data-md]').forEach(btn => {
      btn.addEventListener('click', function () {
        const action = this.getAttribute('data-md');
        switch (action) {
          case 'h1': insertLinePrefix('#'); break;
          case 'h2': insertLinePrefix('##'); break;
          case 'bold': wrapSelection('**', '**'); break;
          case 'italic': wrapSelection('*', '*'); break;
          case 'ul': insertLinePrefix('-'); break;
          case 'code': wrapSelection('\n```bash\n', '\n```\n'); break;
        }
      });
    });

    renderPreview();
  })();
</script>

{% endblock %}
